{"id":1930,"date":"2013-08-27T20:21:00","date_gmt":"2013-08-28T01:21:00","guid":{"rendered":"http:\/\/www.wiredprairie.us\/blog\/?p=1930"},"modified":"2022-06-29T10:21:02","modified_gmt":"2022-06-29T15:21:02","slug":"sending-a-socket-to-a-forked-process-in-node-js","status":"publish","type":"post","link":"https:\/\/www.wiredprairie.us\/blog\/index.php\/archives\/1930","title":{"rendered":"Sending a socket to a forked process in Node.JS"},"content":{"rendered":"\n<p>If you want to fork a process in Node and pass a socket, the current Node documentation has a rather odd example, so I\u2019ve simplified it here for my own sanity (further complicated by the fact that the WebStorm debugger can\u2019t debug a forked Node.JS process, which confused me for too long). Hopefully someone else finds this useful at some point.<\/p>\n\n\n\n<p>Step 1, in a file called <strong>app.js:<\/strong><\/p>\n\n\n\n<pre class=\"wp-block-preformatted\"><span class=\"kwrd\">var<\/span> child = require(<span class=\"str\">'child_process'<\/span>).fork(<span class=\"str\">'socket_handler.js'<\/span>);\n\n<span class=\"rem\">\/\/ Open up the server and send sockets to child<\/span>\n<span class=\"kwrd\">var<\/span> server = require(<span class=\"str\">'net'<\/span>).createServer();\n\nserver.on(<span class=\"str\">'connection'<\/span>, <span class=\"kwrd\">function<\/span> (socket) {\n    child.send(<span class=\"str\">'socket'<\/span>, socket);\n    server.getConnections(<span class=\"kwrd\">function<\/span>(err, count) {\n        console.log(<span class=\"str\">\"Connections: \"<\/span> + count);\n    });\n});\nserver.listen(1337);\n<style type=\"text\/css\">br \/> margin: 0em;&amp;amp;amp;lt;br \/> }&amp;amp;amp;lt;br \/> .csharpcode .lnum { color: #606060; }<\/style>\nAnd then, in a file called <strong>socket_handler<\/strong>.<strong>js<\/strong> which is located in the same directory as <strong>app.js:<\/strong><\/pre>\n\n\n\n<pre class=\"wp-block-preformatted\">process.on(<span class=\"str\">'message'<\/span>, <span class=\"kwrd\">function<\/span>(message, socket) {\n    socket.on(<span class=\"str\">'data'<\/span>, <span class=\"kwrd\">function<\/span>(data) {\n        <span class=\"rem\">\/\/ really poor echo ... :)<\/span>\n        socket.write(data);\n    });\n});<\/pre>\n\n\n\n<p>In this case, the fork happens upon application startup by calling the <strong>fork<\/strong> method of the <strong>child_process<\/strong> module. It starts by executing the code in <strong>socket_handler<\/strong>.<strong>js<\/strong>. As this is a new instance of the V8 engine used by Node.JS, remember there\u2019s a sizable overhead to a forked process.<\/p>\n\n\n\n<p>After creating the server and listening on port 1337, when a connection is made (which can be tested by a terminal emulator or telnet), the socket is passed to the forked process. In fact, it\u2019s not really the object as much as it\u2019s the handle to the new socket.<\/p>\n\n\n\n<p>The <strong>send<\/strong> method takes two parameters, a string message which can be any identifier you want, and the the handle, or socket in this case.<\/p>\n\n\n\n<p>The forked process receives the message via the <strong>message<\/strong> event on the process. If you\u2019re sending more than one message, you can add conditional logic to handle the type of message in the event handler. As part of the call to <strong>fork<\/strong>, you can also pass command line arguments and read them using <strong>process<\/strong>.<strong>argv<\/strong>.<\/p>\n","protected":false},"excerpt":{"rendered":"<p>If you want to fork a process in Node and pass a socket, the current Node documentation has a rather odd example, so I\u2019ve simplified it here for my own sanity (further complicated by the fact that the WebStorm debugger can\u2019t debug a forked Node.JS process, which confused me for too long). Hopefully someone else [&hellip;]<\/p>\n","protected":false},"author":2,"featured_media":0,"comment_status":"open","ping_status":"open","sticky":false,"template":"","format":"standard","meta":{"spay_email":"","jetpack_publicize_message":"","jetpack_is_tweetstorm":false,"jetpack_publicize_feature_enabled":true},"categories":[4],"tags":[38,102],"jetpack_publicize_connections":[],"jetpack_featured_media_url":"","jetpack_sharing_enabled":true,"jetpack_shortlink":"https:\/\/wp.me\/pd5QIe-v8","jetpack_likes_enabled":true,"jetpack-related-posts":[{"id":1820,"url":"https:\/\/www.wiredprairie.us\/blog\/index.php\/archives\/1820","url_meta":{"origin":1930,"position":0},"title":"Knockout binding for JavaScript route fixup","date":"January 25, 2013","format":false,"excerpt":"Part one. After the first round, I felt compelled to KnockOut the code a bit more. I\u2019d mentioned I wasn\u2019t pleased with the code exactly. It needed some refactoring. So, I\u2019ve created a new Knockout binding handler. This binding handler replaces\u00a0 named parameters with a model\u2019s properties in a path.\u2026","rel":"","context":"In &quot;Coding&quot;","img":{"alt_text":"","src":"","width":0,"height":0},"classes":[]},{"id":1442,"url":"https:\/\/www.wiredprairie.us\/blog\/index.php\/archives\/1442","url_meta":{"origin":1930,"position":1},"title":"Nest Thermostat API\/Protocol","date":"January 8, 2012","format":false,"excerpt":"While Nest Labs hasn\u2019t released a formal (documented & supported) API, I thought I\u2019d do a bit of digging to see how they\u2019re using the network and what might be achievable. A few things are going on, the majority as you\u2019d probably expect. The web interface is using a long\u2026","rel":"","context":"In &quot;Coding&quot;","img":{"alt_text":"image","src":"https:\/\/i0.wp.com\/www.wiredprairie.us\/blog\/wp-content\/uploads\/2012\/01\/image_thumb7.png?resize=350%2C200","width":350,"height":200},"classes":[]},{"id":1974,"url":"https:\/\/www.wiredprairie.us\/blog\/index.php\/archives\/1974","url_meta":{"origin":1930,"position":2},"title":"Loading Models in NodeJS","date":"December 2, 2013","format":false,"excerpt":"I\u2019d answered a question on StackOverflow about where to put \u201cmodels\u201d in a NodeJS project. I wanted to elaborate on the simple auto loader I use to load a folder full of models (and I use this pattern other places as well). Normally, I create a folder called models: Inside\u2026","rel":"","context":"In &quot;Coding&quot;","img":{"alt_text":"","src":"","width":0,"height":0},"classes":[]},{"id":1345,"url":"https:\/\/www.wiredprairie.us\/blog\/index.php\/archives\/1345","url_meta":{"origin":1930,"position":3},"title":"Creating a simple Entity Reference system for Ember.js","date":"December 28, 2011","format":false,"excerpt":"I had some data stored in a structure similar to this: Nothing too fancy. A table of Gift(s) and a table of Person(s). Each gift had a foreign key relationship to a Person (the person who \u201cgave\u201d the gift). Since some people may give several gifts, I didn\u2019t want to\u2026","rel":"","context":"In &quot;Coding&quot;","img":{"alt_text":"","src":"","width":0,"height":0},"classes":[]},{"id":1837,"url":"https:\/\/www.wiredprairie.us\/blog\/index.php\/archives\/1837","url_meta":{"origin":1930,"position":4},"title":"How to debug an underscore.js template","date":"February 13, 2013","format":false,"excerpt":"Given a simple template like this: <div class=\"solution\" data-question-id=\"<%= model.get('Id') %>\"> <div class=\"title\"><%= model.get('Name') %><\/div> <div class=\"company\"><%= model.get('Company') %><\/div> <div class=\"version\"><%= model.get('Version') %><\/div> <div class=\"detail\"><%= model.get('Summary') %><\/div> <div class=\"actions\"> <a href=\"\/#solution\/<%= Id %>\/<%= model.get('Id') %>\">Detail<\/a> <\/div> <\/div> And using your favorite JavaScript interactive debugger (Visual Studio 2012 is my favorite\u2026","rel":"","context":"In &quot;Coding&quot;","img":{"alt_text":"","src":"","width":0,"height":0},"classes":[]},{"id":1836,"url":"https:\/\/www.wiredprairie.us\/blog\/index.php\/archives\/1836","url_meta":{"origin":1930,"position":5},"title":"Smarter queuing of files using jQuery deferred and when","date":"February 13, 2013","format":false,"excerpt":"I had a somewhat simple need \u2026a single web page style application using Backbone.JS had multiple template files it needed to download, if and only if the files hadn\u2019t already been downloaded before. While I suppose I could have relied on browser caching, I wanted to manage the requests in\u2026","rel":"","context":"In &quot;Coding&quot;","img":{"alt_text":"","src":"","width":0,"height":0},"classes":[]}],"_links":{"self":[{"href":"https:\/\/www.wiredprairie.us\/blog\/index.php\/wpjson\/wp\/v2\/posts\/1930"}],"collection":[{"href":"https:\/\/www.wiredprairie.us\/blog\/index.php\/wpjson\/wp\/v2\/posts"}],"about":[{"href":"https:\/\/www.wiredprairie.us\/blog\/index.php\/wpjson\/wp\/v2\/types\/post"}],"author":[{"embeddable":true,"href":"https:\/\/www.wiredprairie.us\/blog\/index.php\/wpjson\/wp\/v2\/users\/2"}],"replies":[{"embeddable":true,"href":"https:\/\/www.wiredprairie.us\/blog\/index.php\/wpjson\/wp\/v2\/comments?post=1930"}],"version-history":[{"count":2,"href":"https:\/\/www.wiredprairie.us\/blog\/index.php\/wpjson\/wp\/v2\/posts\/1930\/revisions"}],"predecessor-version":[{"id":2383,"href":"https:\/\/www.wiredprairie.us\/blog\/index.php\/wpjson\/wp\/v2\/posts\/1930\/revisions\/2383"}],"wp:attachment":[{"href":"https:\/\/www.wiredprairie.us\/blog\/index.php\/wpjson\/wp\/v2\/media?parent=1930"}],"wp:term":[{"taxonomy":"category","embeddable":true,"href":"https:\/\/www.wiredprairie.us\/blog\/index.php\/wpjson\/wp\/v2\/categories?post=1930"},{"taxonomy":"post_tag","embeddable":true,"href":"https:\/\/www.wiredprairie.us\/blog\/index.php\/wpjson\/wp\/v2\/tags?post=1930"}],"curies":[{"name":"wp","href":"https:\/\/api.w.org\/{rel}","templated":true}]}}