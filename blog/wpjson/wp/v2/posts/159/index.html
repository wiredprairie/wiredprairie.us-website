{"id":159,"date":"2008-04-28T20:32:56","date_gmt":"2008-04-29T01:32:56","guid":{"rendered":"http:\/\/www.wiredprairie.us\/blog\/index.php\/archives\/159"},"modified":"2008-04-28T20:32:56","modified_gmt":"2008-04-29T01:32:56","slug":"in-an-alternate-universe-net-code-executes-in-parallel","status":"publish","type":"post","link":"https:\/\/www.wiredprairie.us\/blog\/index.php\/archives\/159","title":{"rendered":"In an alternate Universe, .NET code executes in parallel"},"content":{"rendered":"<p>Actually, it&#8217;s right <a href=\"http:\/\/www.microsoft.com\/downloads\/details.aspx?FamilyID=e848dc1d-5be3-4941-8705-024bc7f180ba&amp;displaylang=en\" target=\"_blank\">here<\/a> as the Microsoft Parallel Extensions to the .NET 3.5 Framework Dec. 2007 CTP (what a mouthful!). If you&#8217;re not familiar with these extensions, the brief summary is simple (straight from MSDN):<\/p>\n<blockquote>\n<p>Parallel Extensions to the .NET Framework is a managed programming model for data parallelism, task parallelism, and coordination on parallel hardware unified by a common work scheduler. Parallel Extensions makes it easier for developers to write programs that scale to take advantage of parallel hardware\u2014providing improved performance as the numbers of cores and processors increase\u2014without having to deal with many of the complexities of today\u2019s concurrent programming models. Parallel Extensions provides library-based support for introducing concurrency into applications written with any .NET language, including but not limited to C# and Visual Basic.<\/p>\n<\/blockquote>\n<p> What that&#8217;s trying to say is that it makes it easier to write complex multi-threaded, divide and conquer-style code. If you have code that just uses threads occasionally, maybe via the ThreadPool (or my current favorite, the BackgroundWorker), you could switch to using these extensions. But, the benefits currently won&#8217;t likely outweigh the work necessary to make the switch. If however, you&#8217;ve got code that could take advantage of parallelism, code that is executing on multiple processors <strong>simultaneously <\/strong>(doing the exact same functions), then the extensions may be exactly what you&#8217;re looking for. <\/p>\n<p>I&#8217;ve absolutely written code before which has a queue, multiple threads that are processing the queue, and chugged through that code. It&#8217;s messy, error prone, and subject to performance woes if not written carefully. I hate writing it as it&#8217;s always easier to code incorrectly (or not adequately) than it is to write correctly.<\/p>\n<p>At it&#8217;s most simple, it could be used like this:<\/p>\n<pre class=\"code\"><span style=\"color: blue\">static void <\/span>Main(<span style=\"color: blue\">string<\/span>[] args)\n{\n    <span style=\"color: blue\">int<\/span>[,] data = <span style=\"color: blue\">new int<\/span>[1024, 512];\n    <span style=\"color: #2b91af\">Parallel<\/span>.For(0, 1024, i =&gt;\n    {\n        <span style=\"color: blue\">for <\/span>(<span style=\"color: blue\">int <\/span>j = 0; j &lt; 512; j++)\n        {\n            data[i, j] = (<span style=\"color: blue\">int<\/span>) j * i ;\n        }\n\n        <span style=\"color: #2b91af\">Console<\/span>.Write(<span style=\"color: #a31515\">\"[{0}]\"<\/span>, i);\n    });\n\n    <span style=\"color: #2b91af\">Console<\/span>.WriteLine(<span style=\"color: #a31515\">\"Done!\"<\/span>);\n    <span style=\"color: #2b91af\">Console<\/span>.ReadKey();\n}<\/pre>\n<p><a href=\"http:\/\/11011.net\/software\/vspaste\"><\/a>A simple loop which, in parallel, executes the inner loop to set the rows of data. The Parallel.For statement doesn&#8217;t return until the loop is entirely completed. Super simple. <\/p>\n<p>There&#8217;s no guarantee of order as you can see from these results:<\/p>\n<p><a href=\"http:\/\/www.wiredprairie.us\/blog\/wp-content\/uploads\/2008\/04\/image43.png\"><img loading=\"lazy\" height=\"45\" alt=\"image\" src=\"http:\/\/www.wiredprairie.us\/blog\/wp-content\/uploads\/2008\/04\/image-thumb40.png\" width=\"249\" border=\"0\"\/><\/a>&nbsp;<\/p>\n<p>Clearly, some of the work is being done out of sequence. This is one of the key tenants and rules of the Parallel extensions currently &#8212; the work will be done when the work is done &#8212; in whatever order is determined to be best by the Parallel Task Scheduler. You should never rely on any particular order. <strong>Period<\/strong>. Assume things are in a semi-random sequence.<\/p>\n<p>There is also a handy IEnumerable ForEach iterator:<\/p>\n<pre class=\"code\"><span style=\"color: blue\">static void <\/span>ComputeHashes(<span style=\"color: blue\">string <\/span>startFolder)\n{\n    <span style=\"color: #2b91af\">DirectoryInfo <\/span>rootFolder = <span style=\"color: blue\">new <\/span><span style=\"color: #2b91af\">DirectoryInfo<\/span>(startFolder);\n    <span style=\"color: #2b91af\">FileInfo<\/span>[] files = rootFolder.GetFiles(<span style=\"color: #a31515\">\"*.*\"<\/span>);\n\n    <span style=\"color: #2b91af\">Parallel<\/span>.ForEach&lt;<span style=\"color: #2b91af\">DirectoryInfo<\/span>&gt;(rootFolder.GetDirectories(), dir =&gt;\n    {\n        ComputeHashes(dir.FullName);\n    });\n\n    <span style=\"color: #2b91af\">Parallel<\/span>.ForEach&lt;<span style=\"color: #2b91af\">FileInfo<\/span>&gt;(files, file =&gt;\n    {\n        <span style=\"color: #2b91af\">Console<\/span>.WriteLine(<span style=\"color: #a31515\">\"{0} .... \"<\/span>, file.Name);\n        <span style=\"color: #2b91af\">MD5 <\/span>md5 = <span style=\"color: #2b91af\">MD5<\/span>.Create();\n        <span style=\"color: blue\">byte<\/span>[] hash;\n        <span style=\"color: blue\">using <\/span>(<span style=\"color: #2b91af\">FileStream <\/span>stream = <span style=\"color: #2b91af\">File<\/span>.OpenRead(file.FullName))\n        {\n            hash = md5.ComputeHash(stream);\n        }\n\n        <span style=\"color: #2b91af\">StringBuilder <\/span>sb = <span style=\"color: blue\">new <\/span><span style=\"color: #2b91af\">StringBuilder<\/span>();\n        <span style=\"color: blue\">for <\/span>(<span style=\"color: blue\">int <\/span>i = 0; i &lt; hash.Length; i++)\n        {\n            sb.AppendFormat(<span style=\"color: #a31515\">\"{0:X}\"<\/span>, hash[i]);\n        }\n\n        <span style=\"color: #2b91af\">Console<\/span>.WriteLine(<span style=\"color: #a31515\">\"{0} - {1}\"<\/span>, file.Name, sb.ToString());\n    });\n}\n<\/pre>\n<p>The above example iterates through folders in search of files so that the MD5 HASH checksum can be output. <\/p>\n<p>I&#8217;m not going to attempt to go through all the APIs and options (as there&#8217;s a lot there including Parallel Extensions for LINQ). There&#8217;s ample documentation available on the web, and a well maintained <a href=\"http:\/\/blogs.msdn.com\/pfxteam\/default.aspx\" target=\"_blank\">blog<\/a> by the team at Microsoft. <a href=\"http:\/\/blogs.msdn.com\/pfxteam\/archive\/2008\/04\/03\/8354128.aspx\" target=\"_blank\">This<\/a> blog post in particular answers a bunch of questions that you might have about the Parallel Extensions.<\/p>\n<p>One thing I&#8217;d like to see is for an easier way to debug an application when using the Parallel Extensions. When multiple threads are active, it&#8217;s really tough to debug (even on a single workstation) a multi-threaded application. In my threaded development, I usually have a switch I can set to use only a single thread for testing, debugging, so that I can retain some part of my sanity. I&#8217;d suggest something like a Parallel.DebugMode = true &#8230; I don&#8217;t need to set the specific number of threads &#8230; just give me one. :)<\/p>\n<p>I&#8217;m not clear on when I&#8217;d want to use these extensions, especially on a web server &#8212; seems like the answer is never (or rarely)?<\/p>\n<p>In any case, now&#8217;s the time to check this stuff out so that you can provide feedback before they ship.<\/p>\n","protected":false},"excerpt":{"rendered":"<p>Actually, it&#8217;s right here as the Microsoft Parallel Extensions to the .NET 3.5 Framework Dec. 2007 CTP (what a mouthful!). If you&#8217;re not familiar with these extensions, the brief summary is simple (straight from MSDN): Parallel Extensions to the .NET Framework is a managed programming model for data parallelism, task parallelism, and coordination on parallel [&hellip;]<\/p>\n","protected":false},"author":2,"featured_media":0,"comment_status":"open","ping_status":"open","sticky":false,"template":"","format":"standard","meta":{"spay_email":"","jetpack_publicize_message":"","jetpack_is_tweetstorm":false,"jetpack_publicize_feature_enabled":true},"categories":[4],"tags":[],"jetpack_publicize_connections":[],"jetpack_featured_media_url":"","jetpack_sharing_enabled":true,"jetpack_shortlink":"https:\/\/wp.me\/pd5QIe-2z","jetpack_likes_enabled":true,"jetpack-related-posts":[{"id":338,"url":"https:\/\/www.wiredprairie.us\/blog\/index.php\/archives\/338","url_meta":{"origin":159,"position":0},"title":"Tech Ed 2008 Developer Wrap-Up","date":"June 6, 2008","format":false,"excerpt":"I was hoping to experiment with the promised Silverlight 2.0 Beta 2 bits tonight and on the plane ride home tomorrow, but nothing has been published yet. News of the update to the various tools for Visual Studio was made available here. (Update: It was released after I had hit\u2026","rel":"","context":"In &quot;Coding&quot;","img":{"alt_text":"","src":"https:\/\/i0.wp.com\/www.wiredprairie.us\/blog\/wp-content\/uploads\/2008\/06\/img-0571-thumb.jpg?resize=350%2C200","width":350,"height":200},"classes":[]},{"id":1520,"url":"https:\/\/www.wiredprairie.us\/blog\/index.php\/archives\/1520","url_meta":{"origin":159,"position":1},"title":"Announcing SnugUp version 2","date":"January 29, 2012","format":false,"excerpt":"More than a few years ago, I created SnugUp version 1, which is a handy way of synchronizing folders of images with SmugMug for Windows users. I\u2019ve made a number of changes in the last month based on some requests and the result is a significant update (yet the core\u2026","rel":"","context":"In &quot;Software&quot;","img":{"alt_text":"SNAGHTML1ffa6494","src":"https:\/\/i0.wp.com\/www.wiredprairie.us\/blog\/wp-content\/uploads\/2012\/01\/SNAGHTML1ffa6494.png?resize=350%2C200","width":350,"height":200},"classes":[]},{"id":217,"url":"https:\/\/www.wiredprairie.us\/blog\/index.php\/archives\/217","url_meta":{"origin":159,"position":2},"title":"The ASP.NET Single Page Interface and AJAX Patterns","date":"May 9, 2008","format":false,"excerpt":"Posted on MSDN, by Dino Esposito, \"Single Page Interface and AJAX Patterns.\" What is it? From the article... Single-Page Interface Model To take full advantage of AJAX, you need to have all of your features, or at least most of them, in a single page. This is known as the\u2026","rel":"","context":"In &quot;Coding&quot;","img":{"alt_text":"","src":"","width":0,"height":0},"classes":[]},{"id":175,"url":"https:\/\/www.wiredprairie.us\/blog\/index.php\/archives\/175","url_meta":{"origin":159,"position":3},"title":"What&#8217;s the perfect API?","date":"May 5, 2008","format":false,"excerpt":"I was skimming a rant by someone on arstechnica about how badly messed up Win32 APIs are and how superior everything else is, when this paragraph grabbed my attention: The reason must be that no one in Microsoft actually gives a damn. Each group develops their own UI widgets in\u2026","rel":"","context":"In &quot;Coding&quot;","img":{"alt_text":"","src":"","width":0,"height":0},"classes":[]},{"id":1597,"url":"https:\/\/www.wiredprairie.us\/blog\/index.php\/archives\/1597","url_meta":{"origin":159,"position":4},"title":"Paging Data with SQL Server Compact","date":"April 1, 2012","format":false,"excerpt":"If you\u2019re using SQL Server Compact Editition version 4 or higher, there\u2019s finally a decent and efficient way to do data paging: var streets = db.Query<StreetName>(@\"SELECT * FROM StreetNames ORDER BY Id OFFSET @offset ROWS FETCH NEXT @rows ROWS ONLY\", new { offset = group * GroupSize, rows = GroupSize\u2026","rel":"","context":"In &quot;Coding&quot;","img":{"alt_text":"image","src":"https:\/\/i0.wp.com\/www.wiredprairie.us\/blog\/wp-content\/uploads\/2012\/04\/image9.png?resize=350%2C200","width":350,"height":200},"classes":[]},{"id":426,"url":"https:\/\/www.wiredprairie.us\/blog\/index.php\/archives\/426","url_meta":{"origin":159,"position":5},"title":"Visual WebGUI &#8212; Uh? Neat technology for someone else.","date":"July 16, 2008","format":false,"excerpt":"At the top of the page linked above, you can try the Ajax version or the Silverlight version of their web-mail demo. Try it. I won't say that I'm not impressed by what they've accomplished technically. It's impressive. They use a WinForms designer to build parts of the user interface\u2026","rel":"","context":"In &quot;Coding&quot;","img":{"alt_text":"image","src":"https:\/\/i0.wp.com\/www.wiredprairie.us\/blog\/wp-content\/uploads\/2008\/07\/image-thumb2.png?resize=350%2C200","width":350,"height":200},"classes":[]}],"_links":{"self":[{"href":"https:\/\/www.wiredprairie.us\/blog\/index.php\/wp-json\/wp\/v2\/posts\/159"}],"collection":[{"href":"https:\/\/www.wiredprairie.us\/blog\/index.php\/wp-json\/wp\/v2\/posts"}],"about":[{"href":"https:\/\/www.wiredprairie.us\/blog\/index.php\/wp-json\/wp\/v2\/types\/post"}],"author":[{"embeddable":true,"href":"https:\/\/www.wiredprairie.us\/blog\/index.php\/wp-json\/wp\/v2\/users\/2"}],"replies":[{"embeddable":true,"href":"https:\/\/www.wiredprairie.us\/blog\/index.php\/wp-json\/wp\/v2\/comments?post=159"}],"version-history":[{"count":0,"href":"https:\/\/www.wiredprairie.us\/blog\/index.php\/wp-json\/wp\/v2\/posts\/159\/revisions"}],"wp:attachment":[{"href":"https:\/\/www.wiredprairie.us\/blog\/index.php\/wp-json\/wp\/v2\/media?parent=159"}],"wp:term":[{"taxonomy":"category","embeddable":true,"href":"https:\/\/www.wiredprairie.us\/blog\/index.php\/wp-json\/wp\/v2\/categories?post=159"},{"taxonomy":"post_tag","embeddable":true,"href":"https:\/\/www.wiredprairie.us\/blog\/index.php\/wp-json\/wp\/v2\/tags?post=159"}],"curies":[{"name":"wp","href":"https:\/\/api.w.org\/{rel}","templated":true}]}}