{"id":921,"date":"2010-03-11T20:34:00","date_gmt":"2010-03-12T01:34:00","guid":{"rendered":"http:\/\/www.wiredprairie.us\/blog\/index.php\/archives\/921"},"modified":"2010-03-11T20:34:00","modified_gmt":"2010-03-12T01:34:00","slug":"custom-routehandler-in-asp-net-4-0","status":"publish","type":"post","link":"https:\/\/www.wiredprairie.us\/blog\/index.php\/archives\/921","title":{"rendered":"Custom RouteHandler in ASP.NET 4.0"},"content":{"rendered":"<p>It\u2019s great that some of the innovations from ASP.NET MVC 1.0 were moved into the ASP.NET 4.0 platform. One of those was the <strong>RouteTable<\/strong>. I hadn\u2019t written a custom RouteHandler before, so I thought I\u2019d do a simple one as a demo for myself (and any others who are interested).<\/p>\n<p>This is just an example of how to build one \u2013 <strong>it\u2019s not secure<\/strong>. <\/p>\n<pre class=\"code\"><span style=\"color: blue\">using <\/span>System;\n<span style=\"color: blue\">using <\/span>System.Collections.Generic;\n<span style=\"color: blue\">using <\/span>System.Linq;\n<span style=\"color: blue\">using <\/span>System.Web;\n<span style=\"color: blue\">using <\/span>System.Web.Security;\n<span style=\"color: blue\">using <\/span>System.Web.SessionState;\n<span style=\"color: blue\">using <\/span>System.Web.Routing;\n<span style=\"color: blue\">using <\/span>System.IO;\n\n<span style=\"color: blue\">namespace <\/span>TestWebApplication1\n{\n    <span style=\"color: blue\">public class <\/span><span style=\"color: #2b91af\">Global <\/span>: System.Web.<span style=\"color: #2b91af\">HttpApplication\n    <\/span>{\n        <span style=\"color: blue\">void <\/span>Application_Start(<span style=\"color: blue\">object <\/span>sender, <span style=\"color: #2b91af\">EventArgs <\/span>e)\n        {\n            <span style=\"color: #2b91af\">RouteTable<\/span>.Routes.Add(<span style=\"color: blue\">new <\/span><span style=\"color: #2b91af\">Route<\/span>(<span style=\"color: #a31515\">&quot;Assets\/{locale}\/{assetID}&quot;<\/span>, <span style=\"color: blue\">new <\/span><span style=\"color: #2b91af\">CustomRouteHandler<\/span>()));\n        }\n    }\n\n    <span style=\"color: blue\">public class <\/span><span style=\"color: #2b91af\">CustomRouteHandler <\/span>: <span style=\"color: #2b91af\">IRouteHandler\n    <\/span>{\n        <span style=\"color: blue\">public <\/span><span style=\"color: #2b91af\">IHttpHandler <\/span>GetHttpHandler(<span style=\"color: #2b91af\">RequestContext <\/span>requestContext)\n        {            \n            <span style=\"color: blue\">return new <\/span><span style=\"color: #2b91af\">SimpleFileHttpHandler<\/span>(requestContext);\n        }\n    }\n\n    <span style=\"color: blue\">public class <\/span><span style=\"color: #2b91af\">SimpleFileHttpHandler <\/span>: <span style=\"color: #2b91af\">IHttpHandler\n    <\/span>{\n        <span style=\"color: blue\">private <\/span><span style=\"color: #2b91af\">RequestContext <\/span>_requestContext;\n        <span style=\"color: blue\">private <\/span><span style=\"color: #2b91af\">HttpContext <\/span>_httpContext;\n\n        <span style=\"color: blue\">public <\/span><span style=\"color: #2b91af\">RequestContext <\/span>RequestContext { <span style=\"color: blue\">get<\/span>; <span style=\"color: blue\">private set<\/span>; }\n\n        <span style=\"color: blue\">public <\/span>SimpleFileHttpHandler(<span style=\"color: #2b91af\">RequestContext <\/span>requestContext)\n        {\n            _requestContext = requestContext;\n        }\n\n        <span style=\"color: blue\">public bool <\/span>IsReusable\n        {\n            <span style=\"color: blue\">get <\/span>{ <span style=\"color: blue\">return false<\/span>; }\n        }\n\n        <span style=\"color: blue\">public void <\/span>ProcessRequest(<span style=\"color: #2b91af\">HttpContext <\/span>context)\n        {\n            _httpContext = context;\n\n            <span style=\"color: blue\">string <\/span>assetID = _requestContext.RouteData.Values[<span style=\"color: #a31515\">&quot;assetID&quot;<\/span>].ToString();\n            <span style=\"color: blue\">string <\/span>locale = _requestContext.RouteData.Values[<span style=\"color: #a31515\">&quot;locale&quot;<\/span>].ToString();\n\n            <span style=\"color: blue\">if <\/span>(<span style=\"color: blue\">string<\/span>.IsNullOrWhiteSpace(assetID) || <span style=\"color: blue\">string<\/span>.IsNullOrWhiteSpace(locale)) {\n                <span style=\"color: blue\">throw new <\/span><span style=\"color: #2b91af\">ArgumentException<\/span>();\n            }\n            <span style=\"color: green\">\/\/ this is not adaquate and definitely not secure as it would allow any file to be selected and downloaded\n            \/\/ needs to prevent any sort of hack attempts using encoded paths, etc. should just be a relative path within the\n            \/\/ folder that contains the content and no more. \n            <\/span><span style=\"color: blue\">string <\/span>path = _httpContext.Request.MapPath(<span style=\"color: #a31515\">&quot;~\/Content\/&quot; <\/span>+ assetID, <span style=\"color: #a31515\">&quot;&quot;<\/span>, <span style=\"color: blue\">false<\/span>);\n            <span style=\"color: blue\">if <\/span>(<span style=\"color: #2b91af\">File<\/span>.Exists(path))\n            {               \n                <span style=\"color: green\">\/\/ hard coded to the image\/jpg type (obviously needs to adjust)\n                <\/span>context.Response.AddHeader(<span style=\"color: #a31515\">&quot;Content-Type&quot;<\/span>, <span style=\"color: #a31515\">&quot;image\/jpg&quot;<\/span>);\n                context.Response.AddHeader(<span style=\"color: #a31515\">&quot;Content-Length&quot;<\/span>, <span style=\"color: blue\">new <\/span><span style=\"color: #2b91af\">FileInfo<\/span>(path).Length.ToString());\n                context.Response.WriteFile(path);\n            }\n        }\n    }\n\n\n}<\/pre>\n<p>To use it, I created a folder called Content and copied one of the sample photos included with Windows into the folder, and then modified Default.aspx:<\/p>\n<pre class=\"code\"><span style=\"background: yellow\">&lt;%<\/span><span style=\"color: blue\">@ <\/span><span style=\"color: maroon\">Page <\/span><span style=\"color: red\">Title<\/span><span style=\"color: blue\">=&quot;Home Page&quot; <\/span><span style=\"color: red\">Language<\/span><span style=\"color: blue\">=&quot;C#&quot; <\/span><span style=\"color: red\">MasterPageFile<\/span><span style=\"color: blue\">=&quot;~\/Site.master&quot; <\/span><span style=\"color: red\">AutoEventWireup<\/span><span style=\"color: blue\">=&quot;true&quot;\n    <\/span><span style=\"color: red\">CodeBehind<\/span><span style=\"color: blue\">=&quot;Default.aspx.cs&quot; <\/span><span style=\"color: red\">Inherits<\/span><span style=\"color: blue\">=&quot;TestWebApplication1._Default&quot; <\/span><span style=\"background: yellow\">%&gt;\n\n<\/span><span style=\"color: blue\">&lt;<\/span><span style=\"color: maroon\">asp<\/span><span style=\"color: blue\">:<\/span><span style=\"color: maroon\">Content <\/span><span style=\"color: red\">ID<\/span><span style=\"color: blue\">=&quot;HeaderContent&quot; <\/span><span style=\"color: red\">runat<\/span><span style=\"color: blue\">=&quot;server&quot; <\/span><span style=\"color: red\">ContentPlaceHolderID<\/span><span style=\"color: blue\">=&quot;HeadContent&quot;&gt;\n&lt;\/<\/span><span style=\"color: maroon\">asp<\/span><span style=\"color: blue\">:<\/span><span style=\"color: maroon\">Content<\/span><span style=\"color: blue\">&gt;\n&lt;<\/span><span style=\"color: maroon\">asp<\/span><span style=\"color: blue\">:<\/span><span style=\"color: maroon\">Content <\/span><span style=\"color: red\">ID<\/span><span style=\"color: blue\">=&quot;BodyContent&quot; <\/span><span style=\"color: red\">runat<\/span><span style=\"color: blue\">=&quot;server&quot; <\/span><span style=\"color: red\">ContentPlaceHolderID<\/span><span style=\"color: blue\">=&quot;MainContent&quot;&gt;\n    &lt;<\/span><span style=\"color: maroon\">h2<\/span><span style=\"color: blue\">&gt;\n        <\/span>Welcome to the Route Table Demonstrator\n    <span style=\"color: blue\">&lt;\/<\/span><span style=\"color: maroon\">h2<\/span><span style=\"color: blue\">&gt;\n    &lt;<\/span><span style=\"color: maroon\">h3<\/span><span style=\"color: blue\">&gt;<\/span>This one should work as it's using the not-so-magical route table and a custom iroutehandler.<span style=\"color: blue\">&lt;\/<\/span><span style=\"color: maroon\">h3<\/span><span style=\"color: blue\">&gt;\n    &lt;<\/span><span style=\"color: maroon\">p<\/span><span style=\"color: blue\">&gt;\n        <\/span><span style=\"color: red\">&amp;lt;<\/span>img src=<span style=\"color: red\">&amp;quot;<\/span>\/Assets\/en-us\/Penguins.jpg<span style=\"color: red\">&amp;quot; <\/span>width=<span style=\"color: red\">&amp;quot;<\/span>320<span style=\"color: red\">&amp;quot; <\/span>height=<span style=\"color: red\">&amp;quot;<\/span>200<span style=\"color: red\">&amp;quot; <\/span>\/<span style=\"color: red\">&amp;gt;\n    <\/span><span style=\"color: blue\">&lt;\/<\/span><span style=\"color: maroon\">p<\/span><span style=\"color: blue\">&gt;\n    &lt;<\/span><span style=\"color: maroon\">p<\/span><span style=\"color: blue\">&gt;\n        &lt;<\/span><span style=\"color: maroon\">img <\/span><span style=\"color: red\">src<\/span><span style=\"color: blue\">=&quot;\/Assets\/en-us\/Penguins.jpg&quot; <\/span><span style=\"color: red\">width<\/span><span style=\"color: blue\">=&quot;320&quot; <\/span><span style=\"color: red\">height<\/span><span style=\"color: blue\">=&quot;200&quot; \/&gt;\n    &lt;\/<\/span><span style=\"color: maroon\">p<\/span><span style=\"color: blue\">&gt;\n    &lt;<\/span><span style=\"color: maroon\">h3<\/span><span style=\"color: blue\">&gt;<\/span>THis one shouldn't work due to security in web.config for the folder<span style=\"color: blue\">&lt;\/<\/span><span style=\"color: maroon\">h3<\/span><span style=\"color: blue\">&gt;\n    &lt;<\/span><span style=\"color: maroon\">p<\/span><span style=\"color: blue\">&gt;<\/span><span style=\"color: red\">&amp;lt;<\/span>img src=<span style=\"color: red\">&amp;quot;<\/span>\/Content\/Penguins.jpg<span style=\"color: red\">&amp;quot; <\/span>\/<span style=\"color: red\">&amp;gt;<\/span><span style=\"color: blue\">&lt;\/<\/span><span style=\"color: maroon\">p<\/span><span style=\"color: blue\">&gt;\n    &lt;<\/span><span style=\"color: maroon\">p<\/span><span style=\"color: blue\">&gt;\n        &lt;<\/span><span style=\"color: maroon\">img <\/span><span style=\"color: red\">src<\/span><span style=\"color: blue\">=&quot;\/Content\/Penguins.jpg&quot; \/&gt;\n    &lt;\/<\/span><span style=\"color: maroon\">p<\/span><span style=\"color: blue\">&gt;    \n&lt;\/<\/span><span style=\"color: maroon\">asp<\/span><span style=\"color: blue\">:<\/span><span style=\"color: maroon\">Content<\/span><span style=\"color: blue\">&gt;\n\n<\/span><\/pre>\n<p><a href=\"http:\/\/11011.net\/software\/vspaste\"><\/a>In the Content Folder, I added a web.config file to prevent direct access to the content within the folder:<\/p>\n<pre class=\"code\"><span style=\"color: blue\">&lt;?<\/span><span style=\"color: #a31515\">xml <\/span><span style=\"color: red\">version<\/span><span style=\"color: blue\">=<\/span>&quot;<span style=\"color: blue\">1.0<\/span>&quot;<span style=\"color: blue\">?&gt;\n&lt;<\/span><span style=\"color: #a31515\">configuration<\/span><span style=\"color: blue\">&gt;\n\n  &lt;<\/span><span style=\"color: #a31515\">system.web<\/span><span style=\"color: blue\">&gt;\n    &lt;<\/span><span style=\"color: #a31515\">authorization<\/span><span style=\"color: blue\">&gt;\n      &lt;<\/span><span style=\"color: #a31515\">deny <\/span><span style=\"color: red\">users<\/span><span style=\"color: blue\">=<\/span>&quot;<span style=\"color: blue\">*<\/span>&quot;<span style=\"color: blue\">\/&gt;\n    &lt;\/<\/span><span style=\"color: #a31515\">authorization<\/span><span style=\"color: blue\">&gt;\n \n  &lt;\/<\/span><span style=\"color: #a31515\">system.web<\/span><span style=\"color: blue\">&gt;\n\n  &lt;<\/span><span style=\"color: #a31515\">system.webServer<\/span><span style=\"color: blue\">&gt;\n     &lt;<\/span><span style=\"color: #a31515\">modules <\/span><span style=\"color: red\">runAllManagedModulesForAllRequests<\/span><span style=\"color: blue\">=<\/span>&quot;<span style=\"color: blue\">true<\/span>&quot;<span style=\"color: blue\">\/&gt;\n  &lt;\/<\/span><span style=\"color: #a31515\">system.webServer<\/span><span style=\"color: blue\">&gt;\n&lt;\/<\/span><span style=\"color: #a31515\">configuration<\/span><span style=\"color: blue\">&gt;\n\n<\/span><\/pre>\n<p>This should work without modification on IIS7+ and Visual Studio 2010.<\/p>\n<p><img loading=\"lazy\" style=\"border-bottom: 0px; border-left: 0px; display: inline; border-top: 0px; border-right: 0px\" title=\"image\" border=\"0\" alt=\"image\" src=\"http:\/\/www.wiredprairie.us\/blog\/wp-content\/uploads\/2010\/03\/image3.png\" width=\"400\" height=\"291\" \/><\/p>\n","protected":false},"excerpt":{"rendered":"<p>It\u2019s great that some of the innovations from ASP.NET MVC 1.0 were moved into the ASP.NET 4.0 platform. One of those was the RouteTable. I hadn\u2019t written a custom RouteHandler before, so I thought I\u2019d do a simple one as a demo for myself (and any others who are interested). This is just an example [&hellip;]<\/p>\n","protected":false},"author":2,"featured_media":0,"comment_status":"open","ping_status":"open","sticky":false,"template":"","format":"standard","meta":{"spay_email":"","jetpack_publicize_message":"","jetpack_is_tweetstorm":false,"jetpack_publicize_feature_enabled":true},"categories":[4],"tags":[22],"jetpack_publicize_connections":[],"jetpack_featured_media_url":"","jetpack_sharing_enabled":true,"jetpack_shortlink":"https:\/\/wp.me\/pd5QIe-eR","jetpack_likes_enabled":true,"jetpack-related-posts":[{"id":331,"url":"https:\/\/www.wiredprairie.us\/blog\/index.php\/archives\/331","url_meta":{"origin":921,"position":0},"title":"Velocity &#8212; a rockin&#8217; distributed in memory cache for ASP.NET","date":"June 3, 2008","format":false,"excerpt":"Velocity, the code-name for a new in-memory distributed caching system for ASP.NET was released as a Community Tech Preview today. What is it? It's described in the documentation: Microsoft project code named \"Velocity\" provides a highly scalable in-memory application cache for all kinds of data. By using cache, your application\u2026","rel":"","context":"In &quot;Coding&quot;","img":{"alt_text":"image","src":"https:\/\/i0.wp.com\/www.wiredprairie.us\/blog\/wp-content\/uploads\/2008\/06\/image-thumb.png?resize=350%2C200","width":350,"height":200},"classes":[]},{"id":1850,"url":"https:\/\/www.wiredprairie.us\/blog\/index.php\/archives\/1850","url_meta":{"origin":921,"position":1},"title":"Windows 8 IIS Express with Windows Authentication Prompts for Credentials","date":"March 2, 2013","format":false,"excerpt":"If you\u2019re seeing a credentials prompt every time you launch a local IIS or IIS Express web application that requires Windows Authentication, you\u2019ll likely grow as tired of typing in your password as I was. To add to the annoyance, the Remember my credentials checkbox doesn\u2019t work (nothing is saved).\u2026","rel":"","context":"In &quot;General&quot;","img":{"alt_text":"image","src":"https:\/\/i0.wp.com\/www.wiredprairie.us\/blog\/wp-content\/uploads\/2013\/03\/image_thumb.png?resize=350%2C200","width":350,"height":200},"classes":[]},{"id":388,"url":"https:\/\/www.wiredprairie.us\/blog\/index.php\/archives\/388","url_meta":{"origin":921,"position":2},"title":"Silverlight Weather Demonstration","date":"June 26, 2008","format":false,"excerpt":"Demonstration available here. (You'll need to wait for a moment while it loads the first time). I've created a reasonably simple, yet multi-technology (and discipline) demonstration using Silverlight for the user interface and ASP.NET as the back-end. The demonstration uses: Silverlight 2.0 Data binding Delayed downloading of images \"Web services\"\u2026","rel":"","context":"In &quot;Coding&quot;","img":{"alt_text":"","src":"https:\/\/i0.wp.com\/www.wiredprairie.us\/blog\/wp-content\/uploads\/2008\/06\/image21.png?resize=350%2C200","width":350,"height":200},"classes":[]},{"id":81,"url":"https:\/\/www.wiredprairie.us\/blog\/index.php\/archives\/81","url_meta":{"origin":921,"position":3},"title":"Dirt Simple 301 Redirect on Shared hosting and the 404 trick.","date":"April 8, 2008","format":false,"excerpt":"I'm using a shared hosting account for my web site. I have no control over the file types (extensions) that are handled by ASP.NET -- only the standard file extensions (ASPX, ASMX, etc.) are supported. By request, I was asked to make my old RSS and Atom XML file feeds\u2026","rel":"","context":"In &quot;Coding&quot;","img":{"alt_text":"","src":"","width":0,"height":0},"classes":[]},{"id":1693,"url":"https:\/\/www.wiredprairie.us\/blog\/index.php\/archives\/1693","url_meta":{"origin":921,"position":4},"title":"Simple Node based Http Put simulator","date":"July 31, 2012","format":false,"excerpt":"It\u2019s great what you can accomplish in a few lines of code. The Node based source code below uses express to create a mini view-based web server along with a mock Http Put file upload destination. \/** * Module dependencies. *\/var express = require('express') , routes = require('.\/routes') , http\u2026","rel":"","context":"In &quot;Coding&quot;","img":{"alt_text":"","src":"","width":0,"height":0},"classes":[]},{"id":426,"url":"https:\/\/www.wiredprairie.us\/blog\/index.php\/archives\/426","url_meta":{"origin":921,"position":5},"title":"Visual WebGUI &#8212; Uh? Neat technology for someone else.","date":"July 16, 2008","format":false,"excerpt":"At the top of the page linked above, you can try the Ajax version or the Silverlight version of their web-mail demo. Try it. I won't say that I'm not impressed by what they've accomplished technically. It's impressive. They use a WinForms designer to build parts of the user interface\u2026","rel":"","context":"In &quot;Coding&quot;","img":{"alt_text":"image","src":"https:\/\/i0.wp.com\/www.wiredprairie.us\/blog\/wp-content\/uploads\/2008\/07\/image-thumb2.png?resize=350%2C200","width":350,"height":200},"classes":[]}],"_links":{"self":[{"href":"https:\/\/www.wiredprairie.us\/blog\/index.php\/wp-json\/wp\/v2\/posts\/921"}],"collection":[{"href":"https:\/\/www.wiredprairie.us\/blog\/index.php\/wp-json\/wp\/v2\/posts"}],"about":[{"href":"https:\/\/www.wiredprairie.us\/blog\/index.php\/wp-json\/wp\/v2\/types\/post"}],"author":[{"embeddable":true,"href":"https:\/\/www.wiredprairie.us\/blog\/index.php\/wp-json\/wp\/v2\/users\/2"}],"replies":[{"embeddable":true,"href":"https:\/\/www.wiredprairie.us\/blog\/index.php\/wp-json\/wp\/v2\/comments?post=921"}],"version-history":[{"count":0,"href":"https:\/\/www.wiredprairie.us\/blog\/index.php\/wp-json\/wp\/v2\/posts\/921\/revisions"}],"wp:attachment":[{"href":"https:\/\/www.wiredprairie.us\/blog\/index.php\/wp-json\/wp\/v2\/media?parent=921"}],"wp:term":[{"taxonomy":"category","embeddable":true,"href":"https:\/\/www.wiredprairie.us\/blog\/index.php\/wp-json\/wp\/v2\/categories?post=921"},{"taxonomy":"post_tag","embeddable":true,"href":"https:\/\/www.wiredprairie.us\/blog\/index.php\/wp-json\/wp\/v2\/tags?post=921"}],"curies":[{"name":"wp","href":"https:\/\/api.w.org\/{rel}","templated":true}]}}