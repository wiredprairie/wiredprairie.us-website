{"id":1836,"date":"2013-02-13T07:45:00","date_gmt":"2013-02-13T13:45:00","guid":{"rendered":"http:\/\/www.wiredprairie.us\/blog\/?p=1836"},"modified":"2013-02-13T07:18:26","modified_gmt":"2013-02-13T13:18:26","slug":"smarter-queuing-of-files-using-jquery-deferred-and-when","status":"publish","type":"post","link":"https:\/\/www.wiredprairie.us\/blog\/index.php\/archives\/1836","title":{"rendered":"Smarter queuing of files using jQuery deferred and when"},"content":{"rendered":"<p>I had a somewhat simple need \u2026a single web page style application using <a href=\"http:\/\/backbonejs.org\">Backbone.JS<\/a> had multiple template files it needed to download, if and only if the files hadn\u2019t already been downloaded before. <\/p>\n<p>While I suppose I could have relied on browser caching, I wanted to manage the requests in JavaScript. The trick was that at any given time, a request might include one or more template files, and some of the request might have already been made, or in progress.<\/p>\n<p>Here\u2019s the queuing function:<\/p>\n<pre class=\"csharpcode\">(<span class=\"kwrd\">function<\/span>() {\n    <span class=\"kwrd\">var<\/span> allFiles = {};\n    <span class=\"kwrd\">var<\/span> allResults = {};\n\n    <span class=\"kwrd\">var<\/span> queueRequest = <span class=\"kwrd\">function<\/span> (path, files, options) {\n        options = options || {};\n        files = $.isArray(files) ? files : [files];\n        \n        <span class=\"rem\">\/\/ this will contain all of the deferreds that will be <\/span>\n        <span class=\"rem\">\/\/ wrapped with a `when` deferred<\/span>\n        <span class=\"kwrd\">var<\/span> when = [];\n        <span class=\"rem\">\/\/ might want to override some defaults...<\/span>\n        <span class=\"kwrd\">var<\/span> ajaxOpt = $.extend({\n            dataType: <span class=\"str\">'json'<\/span>,\n            type: <span class=\"str\">'GET'<\/span>\n        }, options.ajax || {});\n\n        <span class=\"rem\">\/\/ go thru each file<\/span>\n        $.each(files, <span class=\"kwrd\">function<\/span> (i, file) {\n            <span class=\"kwrd\">var<\/span> xhr;\n            <span class=\"rem\">\/\/ if we've not seen it before<\/span>\n            <span class=\"kwrd\">if<\/span> (<span class=\"kwrd\">typeof<\/span> allFiles[file] === <span class=\"str\">'undefined'<\/span>) {\n                <span class=\"rem\">\/\/ kick it off<\/span>\n                xhr = $.ajax(path + file, ajaxOpt).done(<span class=\"kwrd\">function<\/span> (data) {\n                    <span class=\"rem\">\/\/ store the file results in the hash index<\/span>\n                    allResults[file] = data;\n                });\n                <span class=\"rem\">\/\/ keep the deferred for later use<\/span>\n                allFiles[file] = xhr;\n                <span class=\"rem\">\/\/ and keey this for later<\/span>\n                when.push(xhr);\n            } <span class=\"kwrd\">else<\/span> {\n                <span class=\"rem\">\/\/ already seen this, so just pack it on<\/span>\n                when.push(allFiles[file]);\n            }\n        });\n        <span class=\"rem\">\/\/ return all of the built up deferreds as a <\/span>\n        <span class=\"rem\">\/\/ single when. this will then wait until <\/span>\n        <span class=\"rem\">\/\/ all are satisfied<\/span>\n        <span class=\"kwrd\">return<\/span> $.when.apply(<span class=\"kwrd\">this<\/span>, when).done(<span class=\"kwrd\">function<\/span> () {\n            <span class=\"kwrd\">if<\/span> ($.isFunction(options.done)) {\n                options.done.call(<span class=\"kwrd\">this<\/span>, allResults);\n            }\n        }).fail(options.error);\n    };\n\n    window.Queue = queueRequest;\n})();<\/pre>\n<p>Queuing is easy enough:<\/p>\n<pre class=\"csharpcode\">Queue(app_url(<span class=\"str\">&quot;api\/template\/&quot;<\/span>), templates, {\n    done: <span class=\"kwrd\">function<\/span> (allFiles) {\n        _.each(templates, <span class=\"kwrd\">function<\/span> (n) {\n            <span class=\"rem\">\/\/ compile only if needed<\/span>\n            <span class=\"kwrd\">if<\/span> (<span class=\"kwrd\">typeof<\/span> allTemplates[n] === <span class=\"str\">'undefined'<\/span>) {\n                allTemplates[n] = _.template(allFiles[n]);\n            }\n        });\n        <span class=\"kwrd\">if<\/span> (<span class=\"kwrd\">typeof<\/span> callback === <span class=\"str\">'function'<\/span>) {\n            callback.call(context, allTemplates);\n        }\n    }\n});<\/pre>\n<p><strong>allTemplates<\/strong> is a list of compiled underscore templates stored elsewhere.<\/p>\n<style type=\"text\/css\">\n.csharpcode, .csharpcode pre\n{\n\tfont-size: small;\n\tcolor: black;\n\tfont-family: consolas, \"Courier New\", courier, monospace;\n\tbackground-color: #ffffff;\n\t\/*white-space: pre;*\/\n}\n.csharpcode pre { margin: 0em; }\n.csharpcode .rem { color: #008000; }\n.csharpcode .kwrd { color: #0000ff; }\n.csharpcode .str { color: #006080; }\n.csharpcode .op { color: #0000c0; }\n.csharpcode .preproc { color: #cc6633; }\n.csharpcode .asp { background-color: #ffff00; }\n.csharpcode .html { color: #800000; }\n.csharpcode .attr { color: #ff0000; }\n.csharpcode .alt \n{\n\tbackground-color: #f4f4f4;\n\twidth: 100%;\n\tmargin: 0em;\n}\n.csharpcode .lnum { color: #606060; }<\/style>\n<\/p>\n<p>The first parameter to the Queue function is the full path to the templates. I\u2019ve got a simple MVC controller that responds with a template given a key, so that\u2019s the path that is provided in the example above. The list of templates (as an array) is passed. <\/p>\n<p>The Queue code returns a jQuery deferred <a href=\"http:\/\/api.jquery.com\/jQuery.when\/\">when<\/a>. The function returns both active and completed ajax requests \u2026 which means that the jQuery when function may immediately fire \u2026 or not. When simply waits for all of the async operations to complete, and then calls the callback passed to <a href=\"http:\/\/api.jquery.com\/deferred.done\/\">done<\/a>. <\/p>\n<p>When complete, the code passes all results back to the requesting function. It\u2019s not filtered as I trusted the caller (no reason to unnecessarily clone the array and waste CPU time). :)&#160; <\/p>\n","protected":false},"excerpt":{"rendered":"<p>I had a somewhat simple need \u2026a single web page style application using Backbone.JS had multiple template files it needed to download, if and only if the files hadn\u2019t already been downloaded before. While I suppose I could have relied on browser caching, I wanted to manage the requests in JavaScript. The trick was that [&hellip;]<\/p>\n","protected":false},"author":2,"featured_media":0,"comment_status":"open","ping_status":"open","sticky":false,"template":"","format":"standard","meta":{"spay_email":"","jetpack_publicize_message":"","jetpack_is_tweetstorm":false,"jetpack_publicize_feature_enabled":true},"categories":[4],"tags":[38],"jetpack_publicize_connections":[],"jetpack_featured_media_url":"","jetpack_sharing_enabled":true,"jetpack_shortlink":"https:\/\/wp.me\/pd5QIe-tC","jetpack_likes_enabled":true,"jetpack-related-posts":[{"id":1820,"url":"https:\/\/www.wiredprairie.us\/blog\/index.php\/archives\/1820","url_meta":{"origin":1836,"position":0},"title":"Knockout binding for JavaScript route fixup","date":"January 25, 2013","format":false,"excerpt":"Part one. After the first round, I felt compelled to KnockOut the code a bit more. I\u2019d mentioned I wasn\u2019t pleased with the code exactly. It needed some refactoring. So, I\u2019ve created a new Knockout binding handler. This binding handler replaces\u00a0 named parameters with a model\u2019s properties in a path.\u2026","rel":"","context":"In &quot;Coding&quot;","img":{"alt_text":"","src":"","width":0,"height":0},"classes":[]},{"id":1570,"url":"https:\/\/www.wiredprairie.us\/blog\/index.php\/archives\/1570","url_meta":{"origin":1836,"position":1},"title":"JavaScript: isScrolledIntoView","date":"March 15, 2012","format":false,"excerpt":"I needed a simple way to detect when a placeholder DIV (that would contain an image) had scrolled into the current viewport of the browser. I\u2019ve seen a few solutions that worked, and a few that didn\u2019t (hello? test your code!). Here\u2019s my simple solution: function isScrolledIntoView(elem) { elem =\u2026","rel":"","context":"In &quot;Coding&quot;","img":{"alt_text":"SmugMupBrowser-live","src":"https:\/\/i0.wp.com\/www.wiredprairie.us\/blog\/wp-content\/uploads\/2012\/03\/SmugMupBrowser-live.gif?resize=350%2C200","width":350,"height":200},"classes":[]},{"id":885,"url":"https:\/\/www.wiredprairie.us\/blog\/index.php\/archives\/885","url_meta":{"origin":1836,"position":2},"title":"Microsoft Ajax Library Declarative Command Alternatives","date":"January 3, 2010","format":false,"excerpt":"There may be another way to accomplish this, but I wanted to have a simple commanding system in the Microsoft Ajax Library which worked outside of the templates. After a number of false starts and frustration brought about by very limited documentation, I discovered a reasonable implementation. I created a\u2026","rel":"","context":"In &quot;Coding&quot;","img":{"alt_text":"","src":"","width":0,"height":0},"classes":[]},{"id":1565,"url":"https:\/\/www.wiredprairie.us\/blog\/index.php\/archives\/1565","url_meta":{"origin":1836,"position":3},"title":"Knockout.JS: Dictionary\/Index and ObservableArray, Part 2","date":"March 10, 2012","format":false,"excerpt":"Ryan suggested an alternative in a comment (and corresponding jsFiddle) to the technique that I\u2019d used in my previous Knockout.JS post. Following his suggestion, I made a few tweaks to my original function (and renamed it yet again): ko.observableArray.fn.withIndex = function (keyName) { var index = ko.computed(function () { var\u2026","rel":"","context":"In &quot;Coding&quot;","img":{"alt_text":"","src":"","width":0,"height":0},"classes":[]},{"id":1563,"url":"https:\/\/www.wiredprairie.us\/blog\/index.php\/archives\/1563","url_meta":{"origin":1836,"position":4},"title":"Knockout.JS: AsDictionary","date":"March 9, 2012","format":false,"excerpt":"I frequently find that I have an array of objects in JavaScript that I want to display in a particular order and also have the ability to quickly locate an object by an ID or a key (and not use the indexOf function). As my recent project is using Knockout.JS,\u2026","rel":"","context":"In &quot;Coding&quot;","img":{"alt_text":"","src":"https:\/\/i0.wp.com\/www.wiredprairie.us\/blog\/wp-content\/uploads\/2012\/03\/image3.png?resize=350%2C200","width":350,"height":200},"classes":[]},{"id":1345,"url":"https:\/\/www.wiredprairie.us\/blog\/index.php\/archives\/1345","url_meta":{"origin":1836,"position":5},"title":"Creating a simple Entity Reference system for Ember.js","date":"December 28, 2011","format":false,"excerpt":"I had some data stored in a structure similar to this: Nothing too fancy. A table of Gift(s) and a table of Person(s). Each gift had a foreign key relationship to a Person (the person who \u201cgave\u201d the gift). Since some people may give several gifts, I didn\u2019t want to\u2026","rel":"","context":"In &quot;Coding&quot;","img":{"alt_text":"","src":"","width":0,"height":0},"classes":[]}],"_links":{"self":[{"href":"https:\/\/www.wiredprairie.us\/blog\/index.php\/wp-json\/wp\/v2\/posts\/1836"}],"collection":[{"href":"https:\/\/www.wiredprairie.us\/blog\/index.php\/wp-json\/wp\/v2\/posts"}],"about":[{"href":"https:\/\/www.wiredprairie.us\/blog\/index.php\/wp-json\/wp\/v2\/types\/post"}],"author":[{"embeddable":true,"href":"https:\/\/www.wiredprairie.us\/blog\/index.php\/wp-json\/wp\/v2\/users\/2"}],"replies":[{"embeddable":true,"href":"https:\/\/www.wiredprairie.us\/blog\/index.php\/wp-json\/wp\/v2\/comments?post=1836"}],"version-history":[{"count":0,"href":"https:\/\/www.wiredprairie.us\/blog\/index.php\/wp-json\/wp\/v2\/posts\/1836\/revisions"}],"wp:attachment":[{"href":"https:\/\/www.wiredprairie.us\/blog\/index.php\/wp-json\/wp\/v2\/media?parent=1836"}],"wp:term":[{"taxonomy":"category","embeddable":true,"href":"https:\/\/www.wiredprairie.us\/blog\/index.php\/wp-json\/wp\/v2\/categories?post=1836"},{"taxonomy":"post_tag","embeddable":true,"href":"https:\/\/www.wiredprairie.us\/blog\/index.php\/wp-json\/wp\/v2\/tags?post=1836"}],"curies":[{"name":"wp","href":"https:\/\/api.w.org\/{rel}","templated":true}]}}